<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSag - Withdraw Funds</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --primary: #0866ff; --bg: #f0f2f5; --red: #ff4d4d; --glass: rgba(255, 255, 255, 0.9); }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 15px; color: #1c1e21; }
        
        .back-btn { text-decoration: none; color: #65676b; font-weight: 700; display: flex; align-items: center; gap: 8px; margin-bottom: 20px; font-size: 14px; }
        
        .card { background: white; padding: 25px; border-radius: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.08); border: 1px solid rgba(0,0,0,0.05); }
        h2 { margin: 0 0 20px; color: #1c1e21; font-size: 24px; text-align: center; font-weight: 900; }
        
        .rules-box { background: #fff5f5; border-radius: 18px; padding: 18px; margin-bottom: 25px; border: 1px dashed var(--red); }
        .rules-box h4 { margin: 0 0 8px; color: var(--red); font-size: 13px; text-transform: uppercase; letter-spacing: 1px; display: flex; align-items: center; gap: 5px; }
        .rules-box p { margin: 0; font-size: 12px; color: #444; line-height: 1.8; font-weight: 600; }

        .input-group { margin-bottom: 18px; }
        label { font-size: 13px; font-weight: 800; color: #4b4f56; display: block; margin-bottom: 8px; margin-left: 5px; }
        input { width: 100%; padding: 15px; border: 2px solid #f0f2f5; border-radius: 15px; box-sizing: border-box; outline: none; font-size: 15px; transition: 0.3s; background: #f9fafb; font-weight: 600; }
        input:focus { border-color: var(--red); background: #fff; box-shadow: 0 0 0 4px rgba(255, 77, 77, 0.1); }

        .btn-withdraw { background: linear-gradient(135deg, #ff4d4d 0%, #ff1a1a 100%); color: white; border: none; width: 100%; padding: 18px; border-radius: 18px; cursor: pointer; font-weight: 800; font-size: 16px; margin-top: 10px; transition: 0.3s; box-shadow: 0 8px 20px rgba(255, 77, 77, 0.3); }
        .btn-withdraw:active { transform: scale(0.97); }

        .history-title { font-weight: 900; margin: 30px 10px 15px; font-size: 20px; color: #1c1e21; }
        .history-item { background: white; padding: 18px; border-radius: 22px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 1px solid #eee; transition: 0.2s; }
        .history-item:active { background: #fafafa; }
        .history-item p { margin: 0; font-weight: 900; font-size: 17px; color: #1c1e21; }
        
        .status-badge { padding: 6px 14px; border-radius: 12px; font-size: 11px; font-weight: 800; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-Pending { background: #fff9e6; color: #d4a017; }
        .status-Success { background: #e7f7ed; color: #28a745; }
        .status-Rejected { background: #fff0f0; color: #ff4d4d; }
    </style>
</head>
<body>

    <a href="dashboard.html" class="back-btn"><i class="fas fa-chevron-left"></i> Dashboard</a>

    <div class="card">
        <h2>Withdrawal</h2>
        
        <div class="rules-box">
            <h4><i class="fas fa-shield-alt"></i> Withdrawal Rules:</h4>
            <p>
                • Minimum: <b>$30.00</b><br>
                • Frequency: <b>2 Times / Month</b><br>
                • Requirement: <b>2 Active Direct Referrals</b>
            </p>
        </div>

        <div class="input-group">
            <label>Withdraw Amount (USD)</label>
            <input type="number" id="wd-amount" placeholder="0.00">
        </div>
        
        <div class="input-group">
            <label>USDT (TRC20) Wallet Address</label>
            <input type="text" id="wd-wallet" placeholder="Paste address here">
        </div>
        
        <div class="input-group">
            <label>WhatsApp Number</label>
            <input type="tel" id="wd-whatsapp" placeholder="+923XXXXXXXXX">
        </div>
        
        <button class="btn-withdraw" id="request-wd">
            Submit Request <i class="fas fa-paper-plane" style="margin-left:8px;"></i>
        </button>
    </div>

    <div class="history-title">Withdrawal History</div>
    <div id="history-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, push, onValue, get, update, query, orderByChild, equalTo } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        // Your Config
        const firebaseConfig = {
            apiKey: "AIzaSyAab16yXGrK5CfUPZ57JgQ_3OxbtXReibY",
            authDomain: "dreamsag-17ed9.firebaseapp.com",
            projectId: "dreamsag-17ed9",
            databaseURL: "https://dreamsag-17ed9-default-rtdb.firebaseio.com/",
            appId: "1:414865998660:web:5b81b4249ff9e359594d11"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        // Professional Toast Notification
        const Toast = Swal.mixin({
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000,
            timerProgressBar: true
        });

        onAuthStateChanged(auth, (user) => {
            if (user) { loadWithdrawHistory(user.uid); }
            else { window.location.href = "index.html"; }
        });

        document.getElementById('request-wd').onclick = async function() {
            const btn = this;
            const amount = parseFloat(document.getElementById('wd-amount').value);
            const wallet = document.getElementById('wd-wallet').value.trim();
            const whatsapp = document.getElementById('wd-whatsapp').value.trim();
            const user = auth.currentUser;

            // Basic Validations with SweetAlert2
            if (!amount || amount < 30) {
                return Swal.fire('Amount Error', 'Minimum withdrawal is $30.00', 'warning');
            }
            if (!wallet || !whatsapp) {
                return Swal.fire('Fields Missing', 'Please provide wallet and WhatsApp.', 'warning');
            }

            // Start Loading state
            Swal.fire({
                title: 'Checking Requirements...',
                allowOutsideClick: false,
                didOpen: () => { Swal.showLoading(); }
            });

            try {
                const userSnap = await get(ref(db, 'users/' + user.uid));
                const userData = userSnap.val();

                // 1. Balance Check
                if (userData.totalBalance < amount) {
                    throw new Error("Insufficient balance in your account.");
                }

                // 2. Monthly Limit Check
                const withdrawals = userData.withdrawals ? Object.values(userData.withdrawals) : [];
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                const monthlyCount = withdrawals.filter(w => {
                    const d = new Date(w.date);
                    return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
                }).length;

                if (monthlyCount >= 2) throw new Error("Monthly limit reached (Max 2 per month).");

                // 3. Referral Check (Dheet logic)
                const q = query(ref(db, 'users'), orderByChild('referredBy'), equalTo(user.uid));
                const refSnap = await get(q);
                let activeRefCount = 0;
                if (refSnap.exists()) {
                    refSnap.forEach((child) => {
                        const member = child.val();
                        // Check if member has active plan
                        if (member.activeInvestment || member.plan || member.activePlanId) activeRefCount++;
                    });
                }
                
                if (activeRefCount < 2) {
                    throw new Error(`You need 2 active referrals. Current: ${activeRefCount}`);
                }

                // Everything is OK - Proceed
                const newWdRef = push(ref(db, 'withdrawals'));
                const wdId = newWdRef.key;
                const wdData = { 
                    amount, wallet, whatsapp, 
                    date: new Date().toISOString(), 
                    status: "Pending", 
                    uid: user.uid, 
                    email: userData.email 
                };

                const updates = {};
                updates['users/' + user.uid + '/totalBalance'] = userData.totalBalance - amount;
                updates['users/' + user.uid + '/withdrawals/' + wdId] = wdData;
                updates['withdrawals/' + wdId] = wdData;

                await update(ref(db), updates);

                Swal.fire({
                    icon: 'success',
                    title: 'Request Sent!',
                    text: 'Your withdrawal is being processed by admin.',
                    confirmButtonColor: '#ff4d4d'
                });
                
                document.getElementById('wd-amount').value = "";
                document.getElementById('wd-wallet').value = "";

            } catch (err) {
                Swal.fire('Request Failed', err.message, 'error');
            }
        };

        function loadWithdrawHistory(uid) {
            onValue(ref(db, 'users/' + uid + '/withdrawals'), (snap) => {
                const container = document.getElementById('history-container');
                container.innerHTML = "";
                const data = snap.val();
                if (!data) {
                    container.innerHTML = "<div style='text-align:center; padding:40px; opacity:0.5; font-size:13px;'>No transactions found yet.</div>";
                    return;
                }
                
                Object.values(data).reverse().forEach(item => {
                    const d = new Date(item.date);
                    const dateStr = d.toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                    container.innerHTML += `
                        <div class="history-item">
                            <div>
                                <p>$${item.amount.toFixed(2)}</p>
                                <span style="font-size:11px; color:#999; font-weight:600;"><i class="far fa-clock"></i> ${dateStr}</span>
                            </div>
                            <span class="status-badge status-${item.status}">${item.status}</span>
                        </div>`;
                });
            });
        }
    </script>
</body>
</html>
