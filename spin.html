<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DreamSag - Lucky Spin</title>
    
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        :root { --primary: #0866ff; --gold: #ffd700; --red: #ff4d4d; --green: #28a745; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; text-align: center; padding: 10px; margin: 0; overflow-x: hidden; }
        
        .back-btn { text-decoration: none; color: #65676b; font-weight: 700; display: flex; align-items: center; gap: 5px; margin: 10px; font-size: 14px; }
        
        .wheel-container { 
            position: relative; 
            width: 85vw; 
            height: 85vw; 
            max-width: 350px; 
            max-height: 350px; 
            margin: 20px auto; 
        }
        
        .wheel-outer { 
            width: 100%; height: 100%; border: 8px solid #333; border-radius: 50%; 
            position: relative; overflow: hidden; box-shadow: 0 10px 30px rgba(0,0,0,0.2); 
            background: #333; 
        }
        
        #wheel { 
            width: 100%; height: 100%; border-radius: 50%; position: relative; 
            transition: transform 4s cubic-bezier(0.15, 0, 0.15, 1); 
            background: conic-gradient(
                var(--red) 0deg 45deg, var(--gold) 45deg 90deg, 
                var(--green) 90deg 135deg, var(--primary) 135deg 180deg,
                var(--red) 180deg 225deg, var(--gold) 225deg 270deg, 
                var(--green) 270deg 315deg, var(--primary) 315deg 360deg
            ); 
        }
        
        .wheel-label { 
            position: absolute; width: 50%; height: 2px; top: 50%; left: 50%; 
            transform-origin: left center; color: white; font-weight: 900; 
            font-size: 11px; text-align: right; padding-right: 25px; 
            box-sizing: border-box; text-shadow: 1px 1px 2px rgba(0,0,0,0.8); 
        }
        
        .pointer { 
            position: absolute; top: -12px; left: 50%; transform: translateX(-50%); 
            width: 0; height: 0; border-left: 12px solid transparent; 
            border-right: 12px solid transparent; border-top: 25px solid #333; 
            z-index: 20; 
        }
        
        .center-dot { 
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            width: 45px; height: 45px; background: white; border-radius: 50%; 
            z-index: 10; border: 4px solid #333; display: flex; align-items: center; justify-content: center;
        }

        .spin-btn { 
            background: linear-gradient(135deg, #ff4d4d, #f92c2c); color: white; border: none; 
            padding: 15px 40px; border-radius: 50px; font-size: 16px; font-weight: 900; 
            cursor: pointer; margin-top: 20px; box-shadow: 0 6px 15px rgba(255, 77, 77, 0.3); 
            transition: 0.3s; width: 70%; max-width: 220px;
        }
        .spin-btn:active { transform: scale(0.95); }
        .spin-btn:disabled { background: #ccc; box-shadow: none; cursor: not-allowed; }

        .spins-left-card { 
            background: white; display: inline-block; padding: 8px 20px; 
            border-radius: 15px; margin-top: 10px; border: 1px solid #ddd; font-size: 14px;
        }
        .spins-left-card b { color: var(--primary); font-size: 18px; }
    </style>
</head>
<body>

    <a href="dashboard.html" class="back-btn"><i class="fas fa-chevron-left"></i> Dashboard</a>
    
    <h2 style="margin: 10px 0; font-size: 20px;">ðŸŽ° Lucky Spin Win</h2>
    
    <div class="spins-left-card">
        Available Spins: <b id="user-spins">0</b>
    </div>

    <div class="wheel-container">
        <div class="pointer"></div>
        <div class="center-dot"><i class="fas fa-bolt" style="color:#ffd700"></i></div>
        <div class="wheel-outer">
            <div id="wheel"></div>
        </div>
    </div>

    <button id="spin-btn" class="spin-btn">SPIN WHEEL ðŸš€</button>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, onValue, get, update } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAab16yXGrK5CfUPZ57JgQ_3OxbtXReibY",
            authDomain: "dreamsag-17ed9.firebaseapp.com",
            projectId: "dreamsag-17ed9",
            databaseURL: "https://dreamsag-17ed9-default-rtdb.firebaseio.com/",
            appId: "1:414865998660:web:5b81b4249ff9e359594d11"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);

        const segments = [
            { text: "$0.50", value: 0.50 }, { text: "Try Again", value: 0 },
            { text: "$1.00", value: 1.00 }, { text: "$0.50", value: 0.50 },
            { text: "$0.20", value: 0.20 }, { text: "$1.00", value: 1.00 },
            { text: "$0.50", value: 0.50 }, { text: "$0.10", value: 0.10 }
        ];

        const wheel = document.getElementById('wheel');
        segments.forEach((seg, i) => {
            const div = document.createElement('div');
            div.className = 'wheel-label';
            div.style.transform = `rotate(${i * 45 + 22.5}deg)`;
            div.innerText = seg.text;
            wheel.appendChild(div);
        });

        let currentSpins = 0;
        let isSpinning = false;
        let rotation = 0;

        onAuthStateChanged(auth, (user) => {
            if (user) {
                onValue(ref(db, 'users/' + user.uid), (snap) => {
                    const data = snap.val() || {};
                    currentSpins = parseInt(data.spinCount || 0);
                    document.getElementById('user-spins').innerText = currentSpins;
                    if(!isSpinning) document.getElementById('spin-btn').disabled = (currentSpins < 1);
                });
            } else { window.location.href = "index.html"; }
        });

        document.getElementById('spin-btn').onclick = async function() {
            if (isSpinning || currentSpins < 1) return;
            
            const user = auth.currentUser;
            const userRef = ref(db, 'users/' + user.uid);
            
            const freshSnap = await get(userRef);
            const freshData = freshSnap.val();
            if(!freshData || (freshData.spinCount || 0) < 1) {
                Swal.fire('Error', 'No spins available!', 'error');
                return;
            }

            isSpinning = true;
            this.disabled = true;

            const rand = Math.random();
            let winAmount = 0.10;
            if (rand > 0.90) winAmount = 1.00;
            else if (rand > 0.70) winAmount = 0.50;
            else if (rand > 0.40) winAmount = 0.20;

            const validIndices = segments.map((s, i) => s.value === winAmount ? i : -1).filter(i => i !== -1);
            const targetIndex = validIndices[Math.floor(Math.random() * validIndices.length)];
            
            const segmentDeg = 45;
            const extraDeg = 1800; 
            const stopAt = 360 - (targetIndex * segmentDeg) - (segmentDeg / 2);
            rotation += extraDeg + stopAt;
            
            wheel.style.transform = `rotate(${rotation}deg)`;

            setTimeout(async () => {
                try {
                    const finalSnap = await get(userRef);
                    const finalData = finalSnap.val();

                    const updates = {};
                    updates['users/' + user.uid + '/earningBalance'] = (finalData.earningBalance || 0) + winAmount;
                    // --- SPIN REPORT UPDATE (ISSUE NO. 4) ---
                    updates['users/' + user.uid + '/spinEarnings'] = (finalData.spinEarnings || 0) + winAmount; 
                    updates['users/' + user.uid + '/spinCount'] = (finalData.spinCount || 0) - 1;

                    await update(ref(db), updates);
                    
                    if(winAmount > 0) {
                        confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });
                    }

                    Swal.fire({
                        title: winAmount > 0 ? 'Congratulations!' : 'Better Luck Next Time!',
                        text: winAmount > 0 ? `You won $${winAmount.toFixed(2)} added to your earnings!` : 'Try again!',
                        icon: winAmount > 0 ? 'success' : 'info',
                        confirmButtonColor: '#0866ff'
                    });

                } catch (err) {
                    Swal.fire('Error', 'Something went wrong.', 'error');
                }
                isSpinning = false;
                document.getElementById('spin-btn').disabled = (currentSpins < 1);
            }, 4100);
        };
    </script>
</body>
</html>
